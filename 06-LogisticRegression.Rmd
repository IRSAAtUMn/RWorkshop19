# Logistic Regression

*Author: Christina Knudson*

## Introduction

The previous chapter covered linear regression, which models a quantitative response variable. This chapter covers logistic regression, which is used to model a binary response variable. Here are some examples of binary responses:

* Whether or not a person wears a helmet while biking
* Whether or not a dog is adopted
* Whether or not a beer is given an award
* Whether or not a tree survives a storm



## Goals


In this module we'll focus on the __"Model"__ and __"Communicate"__ steps in the data science workflow. 

\
\


<center>
<div class="image">
<img src="images/data-science.png" style="width: 475px"/>
<div>source: [Wickham & Grolemund: R for Data Science](http://r4ds.had.co.nz/) </div>
</div>
</center>



\
\


This chapter will cover how to do the following:

* Fit a logistic regression model in R with quantitative and/or categorical predictors.
* Interpret logistic regression models.
* Calculate probabilities.
* Test the significance of regression coefficients.


R's **glm** (generalized linear model) function will be the primary tool used in the chapter.

### Horseshoe Crab Data 

Throughout this module, we will refer to the horseshoe crab data. Some female crabs attract many males while others do not attract any.  The males that cluster around a female are called "satellites." In order to understand what influences the presence of satellite crabs, researchers selected female crabs and collected data on the following characteristics:

* the color of her shell
* the condition of her spine
* the width of her carapace shell (in centimeters)
* the number of male satellites
* the weight of the female (in grams)

In today's example, we will use the width of a female's shell to predict the probability of her having one or more satellites. Let's start by loading the data. 

```{r}
crabs <- read.csv("http://www.cknudson.com/data/crabs.csv")
head(crabs)
```

You can learn more about this data set [here](http://users.stat.ufl.edu/~aa/cda/data.html).



## Model Basics

### Notation and Setup

Recall that  a simple linear regression model has the following form:
\[
\hat{y}_i = \beta_0 + \beta_1 x_i 
\]
where  $x_i$ is  the predictor, $\beta_0$ is the unknown regression intercept,  $\beta_1$ is the unknown regression slope, and $\hat{y}_i$ is the predicted response given $x_i$. 

In order to model a binary response variable, we need to introduce $p_i$, the probability of something happening. For example, this might be the probability of a person wearing a helmet, the probability of a dog being adopted, or the probability of a beer winning an award. Then our logistic regression model has the following form:
\[
\log \left( \dfrac{p_i}{1-p_i} \right) = \beta_0 + \beta_1 x_i .
\]

Recall that we estimated $\beta_0$ and $\beta_1$ to characterize the linear relationship between $x_i$ and $y_i$ in the simple linear regression setting. In the logistic regression setting, we will  estimate $\beta_0$ and $\beta_1$ in order to understand the relationship between $x_i$ and $p_i$.

As a final introductory note, we define the odds as $\dfrac{p_i}{1-p_i}$.


### Fit a Logistic Regression Model

To fit a logistic regression model, we can use the **glm** function:
```{r}
mod <- glm(y ~ width, family = binomial, data = crabs)
```
The first input is the regression formula (Response ~ Predictor),  the second input indicates we have a binary response, and the third input is the data frame. To find the regression coefficients (i.e. the estimates of $\beta_0$ and $\beta_1$), we can use the **coef** command
```{r}
coef(mod)
```

We can now enter these estimates into our logistic regression equation, just as we did in the simple linear regression setting. Our logistic regression equation is 
\[
\log \left( \dfrac{p_i}{1-p_i} \right) = -12.3508 + 0.4972 \; \text{width}_i, 
\]
where $\text{width}_i$ is the width of a female crab's carapace shell and  $p_i$ is her probability of having one or more satellites.



### Interpret the Model

To do some basic interpretation, let's focus on the predictor's coefficient: `r round(coef(mod)[2], 4)`. This is a **positive** number. This tells us that wider crabs have **higher** chances of having one or more satellites. If the predictor's coefficient were **zero**, there would be **no** linear relationship between the width of a female's shell and her log odds of having one or more satellites. If the predictor's coefficient were **negative**, then wider crabs would have **lower** chances of having one or more satellites.


### Calculate Probabilities

Let's use our model for a female crab with a carapace shell that is 25 centimeters in width.  We start by simply substituting  this crab's width into our regression equation:
\begin{align*}
\log \left( \dfrac{p_i}{1-p_i} \right) &= -12.3508177 + 0.4972306 \; \text{width}_i \\
 &= -12.3508177 + 0.4972306 * 25 \\
 &= 0.0799473.
\end{align*}

Now that you understand the idea of prediction, let's use our **predict** command, which we learned about in the regression chapter. We can use it for logistic regression. Again, create a data frame with a value for the predictor, and then use the **predict** command. The first input is the model and the second is the new crab's data frame.

```{r}
newcrab <- data.frame(width =25)
predict(mod, newcrab)
```




We could say that the log odds of a 25 cm female having satellites is about `r round(predict(mod, newcrab), 5)`, but let's make this more interpretable to everyday humans by translating this to a probability. We use a little algebra to solve for $p_i$:

\begin{align*}
\log \left( \dfrac{p_i}{1-p_i} \right) &= 0.0799473 \\
\Rightarrow \left( \dfrac{p_i}{1-p_i} \right) &= \exp(0.0799473) \\
\Rightarrow p_i &= \dfrac{\exp(0.0799473)}{1+\exp(0.0799473)} \\
&= 0.5199762
\end{align*}

Here is our interpretation: the probability of a 25 cm wide female crab having one of more satellites is about `r round(exp(predict(mod, newcrab))/(1+exp(predict(mod, newcrab))), 5)`.








### Test a Regression Coefficient

Recall that an essential question in regression is "Does this predictor actually have a linear relationship the response?"
In the context of the crabs, we want to know whether the carapace width really does have a  linear relationship with the log odds of satellites. 

<!-- * The null hypothesis is that her carapace width has no linear relationship to her log odds of having satellites.  -->
<!-- * The alternative hypothesis is that her carapace width has a linear relationship to her log odds of having satellites.  -->

<!-- Remember: we assume there is *no* relationship until we find evidence that there *is* a relationship. That is, we assume that carapace width is unrelated to the probability of satellites; in order to say the carapace width is related to the probability of satellites, we need evidence. This evidence comes in the form of a statistical test. -->



Recall the **summary** command, which was introduced in the linear regression setting. We can use it in the logistic regression setting, too. Below is the summary for our crab model.

```{r}
summary(mod)
```


Although the summary provides many details about our model, we  focus for now on the p-value in the second row of the coefficients table of the summary output. 

<!-- Recall that our model has two regression coefficients: the intercept $\beta_0$ and the slope $\beta_1$. The first row of the coefficients table displays information for $\beta_0$ and the second row displays information for $\beta_1$. The columns of the coefficients table provide the estimates of our regression coefficients, their standard errors (smaller standard errors indicate higher certainty), test statistics (for testing whether the regression coefficients differ from zero), and the p-values associated with the test statistics. -->

<!-- In order to answer our question ("Does this predictor actually help us predict the response?"), we focus on $\beta_1$, the regression coefficient on the predictor.   (Recall that if $\beta_1 = 0$, then the log odds have no linear relationship with the predictor.) We find the test results in the two right-most columns and the second row in the the coefficients table of the summary. These entries show us that our test statistic is 4.887 and -->

Our p-value is 1.02e-06 (or $1.02 \times 10^{-6}$). We compare our p-value to a threshold (such as $0.05$); **because our p-value is smaller than our threshold of $.05$, we have evidence that the log odds of satellites have a significant linear relationship with the carapace width.**

If the p-value were large, we would not have evidence to say that there is a linear relationship between a female's carapace width and her log odds of having satellites.


##  Half-Time Exercises

### Female Horseshoe Crab Weight

Continue using the  horseshoe crab data to investigate the relationship between a female's weight and the log odds of her having satellites.

* Create a logistic regression using the female's weight as the predictor and whether she has satellites as the response variable.
* Write down the regression equation.
* Do heavier females having higher or lower chances of  having satellites?
* Consider a female weighing 2000 grams. What is the probability that she has one or more satellites?
* Is there a linear relationship between  a female crab's weight and her log odds of satellites? Find the p-value and compare it to a threshold of $0.05$.

### Boundary Water Blowdown

The Boundary Water Canoe Area experienced wind speeds over 90 miles per hour on July 4, 1999. As a result, many trees were blown down. The data set below contains information on the diameter of each tree (**D**) and whether the tree died (**y**). **y** is 1 if the tree died and 0 if the tree survived. You can learn more about this data set [here](https://www.rdocumentation.org/packages/alr4/versions/1.0.5/topics/Blowdown).

```{r}
blowdown <- read.csv("http://www.cknudson.com/data/blowdown.csv")
```

Use this data set to understand the relationship between a tree's diameter and its log odds of death.

* Create a logistic regression using the tree's diameter the predictor and whether it died as the response variable.
* Write down the regression equation.
* Did thicker trees having higher or lower chances of dying?
* Consider a tree 20 cm in diameter. What is the probability that it died?
* Is there a linear relationship between  the tree's diameter and its log odds of dying? Find the p-value and compare it to the threshold of $0.05$.



### Beer

The Minnesota beer data has 44 beers measured on 7 variables: 

1) *Brewery*: Name of the brewery (**factor** with 8 levels)
2) *Beer*: Name of the beer (**factor** with 44 levels)
3) *Description*: Description of the beer (**factor** with 37 levels)
4) *Style*: Style of the beer (**factor** with 3 levels)
5) *ABV*: Alcohol by volume (**numeric**)
6) *IBU*: International bitterness units (**integer**)
7) *Rating*: Beer Advocate rating (**integer**)
8) *Good*: 1 if the beer has a score of at least 90 and 0 otherwise

Data obtained from [Beer Advocate](http://beeradvocate.com) and the websites of the eight breweries.


* Use logistic regression to decide whether beers with higher **ABV** (alcohol by volume) are more likely to have a rating of at least 90. (Hint: Use the variable *Good* as your response.)
* Choose your favorite beer off the list and calculate its probability of having a score of at least 90.

```{r}
beer <- read.csv("http://www.cknudson.com/data/MNbeer.csv")
```


### State Colors

Recall the election data set introduced by Alicia Johnson. The variable **Red** has been added to the data set to indicate whether the state's color is red (1 if red, 0 otherwise).

* Is per capita income related to whether a state is red?
* If a state has a high per capita income, is it more or less likely to be red?

```{r}
election <- read.csv("https://www.macalester.edu/~ajohns24/data/IMAdata1.csv")
election$Red <- as.numeric(election$StateColor == "red")

```

## Half-Time Solutions

### Crab Weight

We create the model and look at the summary to find the p-value for the coefficient on weight The p-value is small ($1.45 \times 10^{-6}$) so we can conclude that a female crab's weight **does** have a significant linear relationship with the log odds of her having one or more satellites.

```{r}
weightmod <- glm(y ~ weight, family = binomial, data = crabs)
summary(weightmod)
```

Now we can use our regression equation to calculate the probability of a 2000 gram female having one or more satellites.
```{r}
newcrab2000 <- data.frame(weight = 2000)
logodds <- predict(weightmod, newcrab2000)
exp(logodds)/(1+exp(logodds))
```
The probability of a 2000 gram female having satellites is `r exp(logodds)/(1+exp(logodds))
`.

### Boundary Water Blowdown

We create the model, isolate the coefficients, and find the summary using the code below.
```{r}
treemod <- glm(y ~ D, data = blowdown, family = binomial)
coef(treemod)
summary(treemod)
```

First, the coefficient on the diameter is positive. This tells us that larger trees were more likely to die. Moreover, the relationship between a trees diameter and its log odds of death is statistically significant: the p-value is quite small (smaller than $2 \times 10^{-16}$).

Finally, the probability of death for a tree that was 20 cm in diameter is calculated below.
```{r}
newtree <- data.frame(D = 20)
(logodds <- predict(treemod, newtree))
exp(logodds)/(1+exp(logodds))
```


### Beer
We create the model and look at the summary to find the p-value for the coefficient on ABV. The p-value is small ($0.00747$) so we can conclude that ABV **does** have a significant linear relationship with the log odds of a beer earning a score of at least 90.

```{r}
beermod <- glm(Good ~ ABV, family = binomial, data = beer)
summary(beermod)
```

### State Colors
We create the model and look at the summary to find the p-value for the coefficient on per capita income. The p-value is very small (smaller than $2.2 \times 10^{-16}$) so we can conclude that per capita income **does** have a significant linear relationship with the log odds of a state being red.
```{r}
electionmod <- glm(Red ~  per_capita_income, family = binomial, data = election)
summary(electionmod)
```

Also, because the coefficient on per capita income is negative, we know that states with **higher** per capita incomes are **less** likely to be red.

## Beyond the Basics

### Interpret the Model (Again!)


We can look beyond just whether the predictor's coefficient ($\beta_1$) is positive or negative. Exponentiating both sides of the regression equation produces
\[
\dfrac{p_i}{1-p_i} = \exp\left( \beta_0 + \beta_1 x_i \right) = \exp\left( \beta_0 \right) \exp\left(  \beta_1 x_i \right).
\]

To understand the relationship between our predictor and the log odds, let's see what happens when we increase $x_i$ by one unit. That is, let's replace $x_i$ with $x_i+1$.

\[
\dfrac{p_i}{1-p_i} =  \exp\left( \beta_0 \right) \exp\left(  \beta_1 (x_i+1) \right) = \exp\left( \beta_0 \right) \exp\left(  \beta_1 x_i \right)\exp\left(  \beta_1  \right).
\]

That is, our odds for predictor value $x_i$ are $\exp\left( \beta_0 \right) \exp\left(  \beta_1 x_i \right)$ while the odds for predictor value $x_i+1$ are $\exp\left( \beta_0 \right) \exp\left(  \beta_1 x_i \right)\exp\left(  \beta_1  \right)$. These two odds differ by a factor of $\exp(\beta_1)$. That is, the ratio of the two odds is $\exp(\beta_1)$:
\[
\dfrac{\exp\left( \beta_0 \right) \exp\left(  \beta_1 x_i \right)\exp\left(  \beta_1  \right)}{\exp\left( \beta_0 \right) \exp\left(  \beta_1 x_i \right)} = \exp(\beta_1).
\]

Therefore, we can say that a one unit increase in the predictor is associated with a $\exp(\beta_1)$ multiplicative change in the odds. Let's try this with the horseshoe crab carapace width model.
```{r}
exp(coef(mod))
```

A one centimeter increase in carapace width is associated with a 1.64 multiplicative change in the odds of having satellites. Alternatively, imagine two female crabs that have carapace widths that differ by exactly 1 cm. The odds of the larger crab having satellites is approximately 1.64 times the odds of the smaller crab having satellites.


### Incorporate a Categorical Predictor

Rather than using a quantitative predictor, we can use a categorical predictor. Let's try using the spine condition in our horseshoe crab data. Crabs were categorized according to whether they had two good spines (*good*), two worn or broken spines (*bad*), or one worn/broken spine and one good spine (*middle*).

We will fit the model using the following **glm** setup.

```{r}
spinemod <- glm(y ~ 0 + spine, data = crabs, family = binomial)
coef(spinemod)
```

This produces three log odds, one for each group (bad, good, and middle). The coefficients represent the log odds of satellites for each group. This tells us that

* the log odds of satellites for a female with two bad spines is `r round(coef(spinemod)[1],3)`
* the log odds of satellites for a female with two good spines is `r round(coef(spinemod)[2],3)`
* the log odds of satellites for a female with one good spine is `r round(coef(spinemod)[3],3)`

Again, most people understand probabilities better than odds or log odds, so let's transform to probabilities:


```{r}
a <- exp(coef(spinemod))
probs <- a/(1+a)
probs
```


This tells us that

* the probability of satellites for a female with two bad spines is `r round(probs[1],3)`
* the probability of satellites for a female with two good spines is `r round(probs[2],3)`
* the probability of satellites for a female with one good spine is `r round(probs[3],3)`


If we eliminate the **0+** in the **glm** formula, we create a model with a reference group; this will compare the bad spine group to the other two groups.

```{r}
spinemod2 <- glm(y ~ spine, data = crabs, family = binomial)
coef(spinemod2)
exp(coef(spinemod2))
```

This model tells us that

* the  odds of satellites for a female with two bad spines is  1.8.
* the odds of satellites for a female with two good spines is 1.3 times the odds of satellites for a female with two bad spines.
* the odds of satellites for a female with one good spine and one bad spine is .48 times the odds of satellites for a female with two bad spines.

Sometimes people have a hard time interpreting odds ratios below 1. In this case, it is useful to flip the ratio.
```{r}
1/exp(coef(spinemod2))
```

Therefore, we can reword the third bullet to the following: the odds of satellites for a female with two bad spines is 2 times the odds of satellites for a female with one bad spine and one good spine.




## More Problems

### Interpret the Slopes

Revisit the models you created in the half-time problems and interpret the slopes.

###  State Colors Again

Return to the election data. Find the probability of a state being red based on its income bracket.

### Beer Again

Return to the beer data. For each style of beer, calculate  the probability of receiving a rating of 90 or higher.


## More Solutions

### Interpret the Slopes

#### Crab Weight

```{r}
logodds <- coef(weightmod)[2]
exp(logodds)
```

A one gram increase in a crab's weight is associated with a multiplicative change of `r exp(logodds)` in the odds of her having satellites.

A 100 gram increase in a crab's weight is associated with a multiplicative change of `r exp(logodds*100)` in her odds of having satellites.


#### Boundary Water Blowdown

```{r}
exp(coef(treemod)[2])
```

A one centimeter increase in a tree's diameter was associated with a `r exp(coef(treemod)[2])
` multiplicative change in the odds of it blowing down.

A ten centimeter increase in a tree's diameter was associated with a `r exp(coef(treemod)[2]*10)` multiplicative change in the odds of it blowing down.

```{r}
exp(coef(treemod)[2]*10)

```

#### Beer


```{r}
exp(coef(beermod)[2])
```

A one percentage point increase in a beer's ABV is associated with a `r exp(coef(treemod)[2])` multiplicative change in its log odds of having a rating of 90 or higher.

#### State Colors

We could look at a one dollar increase in per capita income, but that is not very useful because a dollar is not very meaningful. Let's instead look at a one thousand dollar increase in per capita income.

```{r}
exp((coef(electionmod)[2]*1000))
```

A one thousand dollar increase in a state's average per capita income is associated with a multiplicative change of `r exp((coef(electionmod)[2]*1000))`
in its odds of being red.


### State Colors Again


```{r}
lowhighmod <- glm(Red ~ IncomeBracket, data = election, family = binomial)
exp(coef(lowhighmod))
```
The odds of a high income state being red is about .62. The odds of a low income state being red are about 1.82 times the odds of a high income state being red. That is, low income states are more likely to be red than high income states.

### Beer Again

```{r}
beermod2 <- glm(Good ~ 0+ Style, data=beer, family = binomial)
logodds <- coef(beermod2)
probs <- round(exp(logodds)/(1+exp(logodds)),3)
probs
```

Ales have a `r probs[1]` probability of having a rating of 90 or higher.

IPAs have a `r probs[2]` probability of having a rating of 90 or higher.

The poor lagers have no chance of having a rating of 90 or higher. This  is just based on the data in our data set. Surely if we looked at ALL lagers all over the world, we'd eventually find
one that deserves a rating of 90 or higher.